<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐会反馈</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- SheetJS库 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        .survey-page {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .survey-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        input[type="text"],
        input[type="email"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-prev {
            background-color: #95a5a6;
        }

        .btn-prev:hover {
            background-color: #7f8c8d;
        }

        /* 照片上传区域样式 */
        .photo-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
            background: #f9f9f9;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .preview-item {
            position: relative;
            padding-bottom: 100%;
            overflow: hidden;
            border-radius: 5px;
        }

        .preview-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* 导出按钮样式 */
        .export-btn {
            background-color: #27ae60;
            margin-left: 10px;
        }

        .export-btn:hover {
            background-color: #219a52;
        }

        /* 提示框样式 */
        .toast {
            position: fixed;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            background-color: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        /* 密码弹窗样式 */
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .password-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 300px;
        }

        .password-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .password-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .password-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .password-buttons button {
            padding: 8px 20px;
        }

        .word-count {
            text-align: right;
            color: #666;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .photo-upload {
            margin-bottom: 10px;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .photo-preview img {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* 导出功能样式 */
        .export-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .export-btn {
            background: var(--primary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: var(--secondary-color);
        }

        .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .password-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-color);
            padding: 2rem;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            width: 90%;
            max-width: 400px;
        }

        .password-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .password-input {
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="survey-page">
            <h1>音乐会反馈</h1>
            
            <div class="survey-form">
                <form id="feedbackForm">
                    <div class="form-group">
                        <label>您的姓名</label>
                        <input type="text" id="name" required>
                    </div>

                    <div class="form-group">
                        <label>联系方式</label>
                        <input type="text" id="contact" required>
                    </div>

                    <div class="form-group">
                        <label>您对本场音乐会的整体评价</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="rating" value="很好" required> 很好
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="rating" value="好"> 好
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="rating" value="一般"> 一般
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="rating" value="差"> 差
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>您最喜欢的曲目（可多选）</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="favorite_pieces" value="四海欢腾喜迎春"> 四海欢腾喜迎春
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="favorite_pieces" value="光明行"> 光明行
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="favorite_pieces" value="踏歌"> 踏歌
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="favorite_pieces" value="桃花源"> 桃花源
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="favorite_pieces" value="雨打芭蕉"> 雨打芭蕉
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>喜欢的理由</label>
                        <textarea id="likeReason" class="form-control" rows="4" maxlength="500" required></textarea>
                        <div class="word-count">
                            <span id="wordCount">0</span>/500
                        </div>
                    </div>

                    <div class="form-group">
                        <label>参与人员签到照片</label>
                        <div class="photo-upload">
                            <input type="file" id="participantPhoto" accept="image/jpeg,image/png" multiple>
                            <div class="photo-preview" id="participantPhotoPreview"></div>
                        </div>
                        <small class="form-text text-muted">支持jpg、png格式，单个文件不超过5MB</small>
                    </div>

                    <div class="form-group">
                        <label>优秀人员签到照片</label>
                        <div class="photo-upload">
                            <input type="file" id="excellentPhoto" accept="image/jpeg,image/png" multiple disabled>
                            <div class="photo-preview" id="excellentPhotoPreview"></div>
                        </div>
                        <small class="form-text text-muted">需要填写100字以上的喜欢理由才能上传</small>
                    </div>

                    <div class="navigation-buttons">
                        <a href="video.html" class="btn btn-prev">返回视频</a>
                        <button type="submit" class="btn">提交反馈</button>
                        <button type="button" class="btn export-btn" onclick="showPasswordModal()">导出数据</button>
                    </div>
                </form>
            </div>

            <div class="export-section">
                <h2>数据导出</h2>
                <button class="export-btn" id="exportBtn">导出反馈数据</button>
            </div>
        </div>
    </div>

    <!-- 密码验证模态框 -->
    <div class="password-modal" id="passwordModal">
        <div class="password-content">
            <h2>请输入导出密码</h2>
            <form class="password-form" id="passwordForm">
                <input type="password" class="password-input" id="password" required>
                <button type="submit" class="export-btn">确认</button>
            </form>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 用户认证状态监听
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'index.html';
            }
        });

        // 提交反馈
        function submitFeedback() {
            const feedback = {
                name: document.getElementById('name').value,
                studentId: document.getElementById('studentId').value,
                rating: document.getElementById('rating').value,
                suggestions: document.getElementById('suggestions').value,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // 保存到Firebase
            const feedbackRef = database.ref('feedbacks').push();
            feedbackRef.set(feedback)
                .then(() => {
                    showToast('反馈提交成功！');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                })
                .catch((error) => {
                    showToast('提交失败，请重试');
                    console.error('Error:', error);
                });
        }

        // 导出数据到Excel
        function exportToExcel() {
            const feedbacksRef = database.ref('feedbacks');
            feedbacksRef.once('value').then((snapshot) => {
                const feedbacks = [];
                snapshot.forEach((childSnapshot) => {
                    feedbacks.push(childSnapshot.val());
                });

                if (feedbacks.length === 0) {
                    alert('暂无反馈数据可导出');
                    return;
                }

                // 创建工作簿
                const wb = XLSX.utils.book_new();
                
                // 准备数据
                const data = feedbacks.map(feedback => ({
                    '姓名': feedback.name,
                    '学号': feedback.studentId,
                    '评分': feedback.rating,
                    '建议': feedback.suggestions,
                    '提交时间': new Date(feedback.timestamp).toLocaleString()
                }));

                // 创建工作表
                const ws = XLSX.utils.json_to_sheet(data);
                
                // 将工作表添加到工作簿
                XLSX.utils.book_append_sheet(wb, ws, '反馈数据');

                // 导出文件
                const currentDate = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `音乐会反馈数据_${currentDate}.xlsx`);
            });
        }

        // 密码验证
        function verifyPassword(password) {
            return password === '97452';
        }

        // 导出按钮点击事件
        exportBtn.addEventListener('click', () => {
            passwordModal.style.display = 'block';
        });

        // 密码表单提交
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            
            if (verifyPassword(password)) {
                passwordModal.style.display = 'none';
                exportToExcel();
            } else {
                alert('密码错误');
            }
        });

        // 字数统计和优秀人员照片上传控制
        const likeReasonTextarea = document.getElementById('likeReason');
        const wordCountSpan = document.getElementById('wordCount');
        const excellentPhotoInput = document.getElementById('excellentPhoto');

        likeReasonTextarea.addEventListener('input', function() {
            const currentLength = this.value.length;
            wordCountSpan.textContent = currentLength;
            excellentPhotoInput.disabled = currentLength < 100;
        });

        // 照片上传处理
        function handlePhotoUpload(input, previewId) {
            const files = input.files;
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > 5 * 1024 * 1024) {
                    showToast('文件大小不能超过5MB');
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('participantPhoto').addEventListener('change', function() {
            handlePhotoUpload(this, 'participantPhotoPreview');
        });

        document.getElementById('excellentPhoto').addEventListener('change', function() {
            handlePhotoUpload(this, 'excellentPhotoPreview');
        });

        // 显示密码弹窗
        function showPasswordModal() {
            if (feedbackData.length === 0) {
                showToast('暂无反馈数据可导出');
                return;
            }
            document.getElementById('passwordModal').style.display = 'flex';
        }

        // 关闭密码弹窗
        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        // 显示提示框
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 密码输入框回车事件
        document.getElementById('exportPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyAndExport();
            }
        });
    </script>
</body>
</html> 